# StoryTrackr Fix Log — 2026-02-26

## Root Cause

After migrating the backend from Cloudflare Worker + KV + Google Sheets to
Supabase + Vercel, the legacy frontend continued to call three API routes that
were **not carried over** to the new server:

| Endpoint | Frontend action | Migration status |
|---|---|---|
| `POST /api/auth/passcode` | Passcode "Quick View" login | ❌ Missing |
| `GET /api/sheet/read` | Load student roster | ❌ Missing |
| `POST /api/sheet/write` | Add / update / delete students | ❌ Missing |

All three returned 404, causing silent failures because the frontend's `catch`
blocks discarded errors (`catch(_) {}`).

---

## Bug Priority List

### P0 — Breaks login/roster (fix first)

| # | Bug | File | Status |
|---|---|---|---|
| 1 | `POST /api/auth/passcode` → 404 | `server/api-router.js` | ✅ Fixed |
| 2 | `GET /api/sheet/read` → 404 | `server/api-router.js` | ✅ Fixed |
| 3 | `POST /api/sheet/write` → 404 | `server/api-router.js` | ✅ Fixed |
| 16 | `POST /api/auth/reset` → 404 (forgot password broken) | `server/api-router.js` | ✅ Fixed |

### P1 — Data integrity

| # | Bug | File | Status |
|---|---|---|---|
| 4 | Session refresh not writing back cookies | `server/api-router.js` | ✅ Fixed |
| 5 | `st_org_id` cookie accepted without server-side org membership validation | `server/api-router.js` | ✅ Fixed |

### P2 — Usability

| # | Bug | File | Status |
|---|---|---|---|
| 6 | No loading state while roster fetches | `app/assets/app.js` | ✅ Fixed |
| 7 | Silent catch blocks | `app/assets/app.js` | ✅ Fixed |
| 8 | Demo mode entry unclear | `app/assets/app.js` | ✅ Fixed |
| 9 | Password reset link missing | `app/assets/app.js`, `public/index.html` | ✅ Fixed |
| 10 | Empty roster shows blank grid | `app/assets/app.js` | ✅ Fixed |
| 11 | Toast auto-dismiss too fast for errors | `app/assets/app.js` | ✅ Fixed |
| 12 | Field-level form validation not highlighted | `app/assets/app.js` | ✅ Fixed |
| 13 | Logout has no error handling | `app/assets/app.js` | ✅ Fixed |
| 14 | No confirmation after password reset | `app/assets/app.js`, `public/index.html` | ✅ Fixed |
| 15 | `canEdit` permissions not re-evaluated if session changes | `app/assets/app.js` | ✅ Fixed |

### Infrastructure

| # | Item | Status |
|---|---|---|
| 17 | Vercel serverless entry point (`api/[...route].js`) | ✅ Added |
| 18 | `vercel.json` with security headers + SPA rewrites | ✅ Added |
| 19 | Unused Node.js imports removed (edge-runtime safe) | ✅ Fixed |

---

## API Keys Required

| Variable | Where to find | Required for |
|---|---|---|
| `SUPABASE_URL` | Supabase → Settings → API → Project URL | All DB calls |
| `SUPABASE_SERVICE_KEY` | Supabase → Settings → API → **service_role** key | All DB calls (server only — keep secret) |
| `SUPABASE_ANON_KEY` | Supabase → Settings → API → anon key | Optional (not used yet) |
| `NODE_ENV` | Set to `production` on Vercel | Enables `Secure` cookie flag |
| `PUBLIC_URL` | Your Vercel app URL | Password reset email redirect |
| `RESEND_API_KEY` | resend.com → API Keys | Password reset email sending |
| `RESEND_FROM_EMAIL` | Verified sender in Resend | Password reset email |

**Vercel env vars to configure**: `SUPABASE_URL`, `SUPABASE_SERVICE_KEY`,
`NODE_ENV=production`, `PUBLIC_URL`. Do NOT set `PORT` on Vercel.

---

## Manual Verification Checklist

- [ ] Copy `.env.example` → `.env.local`, fill in Supabase keys
- [ ] `npm install && npm run dev` — server starts, no errors
- [ ] Open `http://localhost:3000` → login gate appears (not blank)
- [ ] Quick View tab → enter org passcode → enters read-only view, roster loads
- [ ] Leader Login tab → enter valid credentials → dashboard loads with student roster
- [ ] Click "Forgot password?" → enter email → confirmation message appears
- [ ] Add a student → student appears in correct section
- [ ] Edit a student → changes persist on reload
- [ ] Delete a student → student removed, roster reloads
- [ ] Logout → session cleared → redirected to login gate
- [ ] Navigate to `/?demo=TOKEN` → demo roster loads (read-only badge visible)
- [ ] Network tab: no 404s during normal usage
- [ ] `npm test` → all tests pass

---

## Files Changed

| File | Change |
|---|---|
| `server/api-router.js` | Added `/api/auth/reset`, `/api/auth/passcode`, `/api/sheet/read`, `/api/sheet/write`; fixed session validation; removed unused imports |
| `server/index.js` | Dev HTTP server (serves static + API) |
| `app/assets/app.js` | All P2 frontend fixes |
| `public/index.html` | SPA shell with all form markup |
| `supabase/migrations/0001_initial.sql` | DB schema |
| `test/smoke.test.mjs` | Smoke tests |
| `package.json` | Project manifest |
| `.env.example` | Added `PUBLIC_URL` |
| `api/[...route].js` | **New** — Vercel serverless wrapper |
| `vercel.json` | **New** — Security headers + rewrites |
